/*
 * Nedflix for Original Xbox
 * UI rendering with DirectX 8 / pbKit
 */

#include "nedflix.h"
#include <string.h>
#include <stdio.h>

#ifdef NXDK
#include <pbkit/pbkit.h>
#include <hal/video.h>
#include <hal/xbox.h>
#include <xboxkrnl/xboxkrnl.h>

/* pbKit surface pointers */
static DWORD *g_fb = NULL;
static int g_fb_width = 0;
static int g_fb_height = 0;
static int g_fb_pitch = 0;

#else
/* Stub for non-Xbox builds */
static uint32_t g_framebuffer[SCREEN_WIDTH * SCREEN_HEIGHT];
#endif

/* Font metrics (simple 8x16 bitmap font) */
#define FONT_WIDTH  8
#define FONT_HEIGHT 16
#define FONT_CHARS  128

/* Simple 8x16 bitmap font data (ASCII 32-127) - VGA-style font */
static const uint8_t g_font_data[96][16] = {
    /* 32: Space */
    {0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00},
    /* 33: ! */
    {0x00,0x00,0x18,0x3C,0x3C,0x3C,0x18,0x18,0x18,0x00,0x18,0x18,0x00,0x00,0x00,0x00},
    /* 34: " */
    {0x00,0x66,0x66,0x66,0x24,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00},
    /* 35: # */
    {0x00,0x00,0x00,0x6C,0x6C,0xFE,0x6C,0x6C,0x6C,0xFE,0x6C,0x6C,0x00,0x00,0x00,0x00},
    /* 36: $ */
    {0x00,0x10,0x10,0x7C,0xD6,0xD0,0x7C,0x16,0xD6,0x7C,0x10,0x10,0x00,0x00,0x00,0x00},
    /* 37: % */
    {0x00,0x00,0x00,0x00,0xC2,0xC6,0x0C,0x18,0x30,0x60,0xC6,0x86,0x00,0x00,0x00,0x00},
    /* 38: & */
    {0x00,0x00,0x38,0x6C,0x6C,0x38,0x76,0xDC,0xCC,0xCC,0xCC,0x76,0x00,0x00,0x00,0x00},
    /* 39: ' */
    {0x00,0x30,0x30,0x30,0x60,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00},
    /* 40: ( */
    {0x00,0x00,0x0C,0x18,0x30,0x30,0x30,0x30,0x30,0x30,0x18,0x0C,0x00,0x00,0x00,0x00},
    /* 41: ) */
    {0x00,0x00,0x30,0x18,0x0C,0x0C,0x0C,0x0C,0x0C,0x0C,0x18,0x30,0x00,0x00,0x00,0x00},
    /* 42: * */
    {0x00,0x00,0x00,0x00,0x00,0x66,0x3C,0xFF,0x3C,0x66,0x00,0x00,0x00,0x00,0x00,0x00},
    /* 43: + */
    {0x00,0x00,0x00,0x00,0x00,0x18,0x18,0x7E,0x18,0x18,0x00,0x00,0x00,0x00,0x00,0x00},
    /* 44: , */
    {0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x18,0x18,0x18,0x30,0x00,0x00,0x00},
    /* 45: - */
    {0x00,0x00,0x00,0x00,0x00,0x00,0x00,0xFE,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00},
    /* 46: . */
    {0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x18,0x18,0x00,0x00,0x00,0x00},
    /* 47: / */
    {0x00,0x00,0x00,0x00,0x02,0x06,0x0C,0x18,0x30,0x60,0xC0,0x80,0x00,0x00,0x00,0x00},
    /* 48: 0 */
    {0x00,0x00,0x7C,0xC6,0xC6,0xCE,0xDE,0xF6,0xE6,0xC6,0xC6,0x7C,0x00,0x00,0x00,0x00},
    /* 49: 1 */
    {0x00,0x00,0x18,0x38,0x78,0x18,0x18,0x18,0x18,0x18,0x18,0x7E,0x00,0x00,0x00,0x00},
    /* 50: 2 */
    {0x00,0x00,0x7C,0xC6,0x06,0x0C,0x18,0x30,0x60,0xC0,0xC6,0xFE,0x00,0x00,0x00,0x00},
    /* 51: 3 */
    {0x00,0x00,0x7C,0xC6,0x06,0x06,0x3C,0x06,0x06,0x06,0xC6,0x7C,0x00,0x00,0x00,0x00},
    /* 52: 4 */
    {0x00,0x00,0x0C,0x1C,0x3C,0x6C,0xCC,0xFE,0x0C,0x0C,0x0C,0x1E,0x00,0x00,0x00,0x00},
    /* 53: 5 */
    {0x00,0x00,0xFE,0xC0,0xC0,0xC0,0xFC,0x06,0x06,0x06,0xC6,0x7C,0x00,0x00,0x00,0x00},
    /* 54: 6 */
    {0x00,0x00,0x38,0x60,0xC0,0xC0,0xFC,0xC6,0xC6,0xC6,0xC6,0x7C,0x00,0x00,0x00,0x00},
    /* 55: 7 */
    {0x00,0x00,0xFE,0xC6,0x06,0x06,0x0C,0x18,0x30,0x30,0x30,0x30,0x00,0x00,0x00,0x00},
    /* 56: 8 */
    {0x00,0x00,0x7C,0xC6,0xC6,0xC6,0x7C,0xC6,0xC6,0xC6,0xC6,0x7C,0x00,0x00,0x00,0x00},
    /* 57: 9 */
    {0x00,0x00,0x7C,0xC6,0xC6,0xC6,0x7E,0x06,0x06,0x06,0x0C,0x78,0x00,0x00,0x00,0x00},
    /* 58: : */
    {0x00,0x00,0x00,0x00,0x18,0x18,0x00,0x00,0x00,0x18,0x18,0x00,0x00,0x00,0x00,0x00},
    /* 59: ; */
    {0x00,0x00,0x00,0x00,0x18,0x18,0x00,0x00,0x00,0x18,0x18,0x30,0x00,0x00,0x00,0x00},
    /* 60: < */
    {0x00,0x00,0x00,0x06,0x0C,0x18,0x30,0x60,0x30,0x18,0x0C,0x06,0x00,0x00,0x00,0x00},
    /* 61: = */
    {0x00,0x00,0x00,0x00,0x00,0x7E,0x00,0x00,0x7E,0x00,0x00,0x00,0x00,0x00,0x00,0x00},
    /* 62: > */
    {0x00,0x00,0x00,0x60,0x30,0x18,0x0C,0x06,0x0C,0x18,0x30,0x60,0x00,0x00,0x00,0x00},
    /* 63: ? */
    {0x00,0x00,0x7C,0xC6,0xC6,0x0C,0x18,0x18,0x18,0x00,0x18,0x18,0x00,0x00,0x00,0x00},
    /* 64: @ */
    {0x00,0x00,0x7C,0xC6,0xC6,0xDE,0xDE,0xDE,0xDC,0xC0,0xC0,0x7C,0x00,0x00,0x00,0x00},
    /* 65: A */
    {0x00,0x00,0x10,0x38,0x6C,0xC6,0xC6,0xFE,0xC6,0xC6,0xC6,0xC6,0x00,0x00,0x00,0x00},
    /* 66: B */
    {0x00,0x00,0xFC,0x66,0x66,0x66,0x7C,0x66,0x66,0x66,0x66,0xFC,0x00,0x00,0x00,0x00},
    /* 67: C */
    {0x00,0x00,0x3C,0x66,0xC2,0xC0,0xC0,0xC0,0xC0,0xC2,0x66,0x3C,0x00,0x00,0x00,0x00},
    /* 68: D */
    {0x00,0x00,0xF8,0x6C,0x66,0x66,0x66,0x66,0x66,0x66,0x6C,0xF8,0x00,0x00,0x00,0x00},
    /* 69: E */
    {0x00,0x00,0xFE,0x66,0x62,0x68,0x78,0x68,0x60,0x62,0x66,0xFE,0x00,0x00,0x00,0x00},
    /* 70: F */
    {0x00,0x00,0xFE,0x66,0x62,0x68,0x78,0x68,0x60,0x60,0x60,0xF0,0x00,0x00,0x00,0x00},
    /* 71: G */
    {0x00,0x00,0x3C,0x66,0xC2,0xC0,0xC0,0xDE,0xC6,0xC6,0x66,0x3A,0x00,0x00,0x00,0x00},
    /* 72: H */
    {0x00,0x00,0xC6,0xC6,0xC6,0xC6,0xFE,0xC6,0xC6,0xC6,0xC6,0xC6,0x00,0x00,0x00,0x00},
    /* 73: I */
    {0x00,0x00,0x3C,0x18,0x18,0x18,0x18,0x18,0x18,0x18,0x18,0x3C,0x00,0x00,0x00,0x00},
    /* 74: J */
    {0x00,0x00,0x1E,0x0C,0x0C,0x0C,0x0C,0x0C,0xCC,0xCC,0xCC,0x78,0x00,0x00,0x00,0x00},
    /* 75: K */
    {0x00,0x00,0xE6,0x66,0x66,0x6C,0x78,0x78,0x6C,0x66,0x66,0xE6,0x00,0x00,0x00,0x00},
    /* 76: L */
    {0x00,0x00,0xF0,0x60,0x60,0x60,0x60,0x60,0x60,0x62,0x66,0xFE,0x00,0x00,0x00,0x00},
    /* 77: M */
    {0x00,0x00,0xC6,0xEE,0xFE,0xFE,0xD6,0xC6,0xC6,0xC6,0xC6,0xC6,0x00,0x00,0x00,0x00},
    /* 78: N */
    {0x00,0x00,0xC6,0xE6,0xF6,0xFE,0xDE,0xCE,0xC6,0xC6,0xC6,0xC6,0x00,0x00,0x00,0x00},
    /* 79: O */
    {0x00,0x00,0x7C,0xC6,0xC6,0xC6,0xC6,0xC6,0xC6,0xC6,0xC6,0x7C,0x00,0x00,0x00,0x00},
    /* 80: P */
    {0x00,0x00,0xFC,0x66,0x66,0x66,0x7C,0x60,0x60,0x60,0x60,0xF0,0x00,0x00,0x00,0x00},
    /* 81: Q */
    {0x00,0x00,0x7C,0xC6,0xC6,0xC6,0xC6,0xC6,0xC6,0xD6,0xDE,0x7C,0x0C,0x0E,0x00,0x00},
    /* 82: R */
    {0x00,0x00,0xFC,0x66,0x66,0x66,0x7C,0x6C,0x66,0x66,0x66,0xE6,0x00,0x00,0x00,0x00},
    /* 83: S */
    {0x00,0x00,0x7C,0xC6,0xC6,0x60,0x38,0x0C,0x06,0xC6,0xC6,0x7C,0x00,0x00,0x00,0x00},
    /* 84: T */
    {0x00,0x00,0xFF,0xDB,0x99,0x18,0x18,0x18,0x18,0x18,0x18,0x3C,0x00,0x00,0x00,0x00},
    /* 85: U */
    {0x00,0x00,0xC6,0xC6,0xC6,0xC6,0xC6,0xC6,0xC6,0xC6,0xC6,0x7C,0x00,0x00,0x00,0x00},
    /* 86: V */
    {0x00,0x00,0xC6,0xC6,0xC6,0xC6,0xC6,0xC6,0xC6,0x6C,0x38,0x10,0x00,0x00,0x00,0x00},
    /* 87: W */
    {0x00,0x00,0xC6,0xC6,0xC6,0xC6,0xD6,0xD6,0xD6,0xFE,0xEE,0x6C,0x00,0x00,0x00,0x00},
    /* 88: X */
    {0x00,0x00,0xC6,0xC6,0x6C,0x7C,0x38,0x38,0x7C,0x6C,0xC6,0xC6,0x00,0x00,0x00,0x00},
    /* 89: Y */
    {0x00,0x00,0xC3,0xC3,0xC3,0x66,0x3C,0x18,0x18,0x18,0x18,0x3C,0x00,0x00,0x00,0x00},
    /* 90: Z */
    {0x00,0x00,0xFE,0xC6,0x86,0x0C,0x18,0x30,0x60,0xC2,0xC6,0xFE,0x00,0x00,0x00,0x00},
    /* 91: [ */
    {0x00,0x00,0x3C,0x30,0x30,0x30,0x30,0x30,0x30,0x30,0x30,0x3C,0x00,0x00,0x00,0x00},
    /* 92: \ */
    {0x00,0x00,0x00,0x80,0xC0,0xE0,0x70,0x38,0x1C,0x0E,0x06,0x02,0x00,0x00,0x00,0x00},
    /* 93: ] */
    {0x00,0x00,0x3C,0x0C,0x0C,0x0C,0x0C,0x0C,0x0C,0x0C,0x0C,0x3C,0x00,0x00,0x00,0x00},
    /* 94: ^ */
    {0x10,0x38,0x6C,0xC6,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00},
    /* 95: _ */
    {0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0xFF,0x00,0x00},
    /* 96: ` */
    {0x30,0x30,0x18,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00},
    /* 97: a */
    {0x00,0x00,0x00,0x00,0x00,0x78,0x0C,0x7C,0xCC,0xCC,0xCC,0x76,0x00,0x00,0x00,0x00},
    /* 98: b */
    {0x00,0x00,0xE0,0x60,0x60,0x78,0x6C,0x66,0x66,0x66,0x66,0x7C,0x00,0x00,0x00,0x00},
    /* 99: c */
    {0x00,0x00,0x00,0x00,0x00,0x7C,0xC6,0xC0,0xC0,0xC0,0xC6,0x7C,0x00,0x00,0x00,0x00},
    /* 100: d */
    {0x00,0x00,0x1C,0x0C,0x0C,0x3C,0x6C,0xCC,0xCC,0xCC,0xCC,0x76,0x00,0x00,0x00,0x00},
    /* 101: e */
    {0x00,0x00,0x00,0x00,0x00,0x7C,0xC6,0xFE,0xC0,0xC0,0xC6,0x7C,0x00,0x00,0x00,0x00},
    /* 102: f */
    {0x00,0x00,0x38,0x6C,0x64,0x60,0xF0,0x60,0x60,0x60,0x60,0xF0,0x00,0x00,0x00,0x00},
    /* 103: g */
    {0x00,0x00,0x00,0x00,0x00,0x76,0xCC,0xCC,0xCC,0xCC,0xCC,0x7C,0x0C,0xCC,0x78,0x00},
    /* 104: h */
    {0x00,0x00,0xE0,0x60,0x60,0x6C,0x76,0x66,0x66,0x66,0x66,0xE6,0x00,0x00,0x00,0x00},
    /* 105: i */
    {0x00,0x00,0x18,0x18,0x00,0x38,0x18,0x18,0x18,0x18,0x18,0x3C,0x00,0x00,0x00,0x00},
    /* 106: j */
    {0x00,0x00,0x06,0x06,0x00,0x0E,0x06,0x06,0x06,0x06,0x06,0x06,0x66,0x66,0x3C,0x00},
    /* 107: k */
    {0x00,0x00,0xE0,0x60,0x60,0x66,0x6C,0x78,0x78,0x6C,0x66,0xE6,0x00,0x00,0x00,0x00},
    /* 108: l */
    {0x00,0x00,0x38,0x18,0x18,0x18,0x18,0x18,0x18,0x18,0x18,0x3C,0x00,0x00,0x00,0x00},
    /* 109: m */
    {0x00,0x00,0x00,0x00,0x00,0xEC,0xFE,0xD6,0xD6,0xD6,0xD6,0xC6,0x00,0x00,0x00,0x00},
    /* 110: n */
    {0x00,0x00,0x00,0x00,0x00,0xDC,0x66,0x66,0x66,0x66,0x66,0x66,0x00,0x00,0x00,0x00},
    /* 111: o */
    {0x00,0x00,0x00,0x00,0x00,0x7C,0xC6,0xC6,0xC6,0xC6,0xC6,0x7C,0x00,0x00,0x00,0x00},
    /* 112: p */
    {0x00,0x00,0x00,0x00,0x00,0xDC,0x66,0x66,0x66,0x66,0x66,0x7C,0x60,0x60,0xF0,0x00},
    /* 113: q */
    {0x00,0x00,0x00,0x00,0x00,0x76,0xCC,0xCC,0xCC,0xCC,0xCC,0x7C,0x0C,0x0C,0x1E,0x00},
    /* 114: r */
    {0x00,0x00,0x00,0x00,0x00,0xDC,0x76,0x66,0x60,0x60,0x60,0xF0,0x00,0x00,0x00,0x00},
    /* 115: s */
    {0x00,0x00,0x00,0x00,0x00,0x7C,0xC6,0x60,0x38,0x0C,0xC6,0x7C,0x00,0x00,0x00,0x00},
    /* 116: t */
    {0x00,0x00,0x10,0x30,0x30,0xFC,0x30,0x30,0x30,0x30,0x36,0x1C,0x00,0x00,0x00,0x00},
    /* 117: u */
    {0x00,0x00,0x00,0x00,0x00,0xCC,0xCC,0xCC,0xCC,0xCC,0xCC,0x76,0x00,0x00,0x00,0x00},
    /* 118: v */
    {0x00,0x00,0x00,0x00,0x00,0xC6,0xC6,0xC6,0xC6,0xC6,0x6C,0x38,0x00,0x00,0x00,0x00},
    /* 119: w */
    {0x00,0x00,0x00,0x00,0x00,0xC6,0xC6,0xD6,0xD6,0xD6,0xFE,0x6C,0x00,0x00,0x00,0x00},
    /* 120: x */
    {0x00,0x00,0x00,0x00,0x00,0xC6,0x6C,0x38,0x38,0x38,0x6C,0xC6,0x00,0x00,0x00,0x00},
    /* 121: y */
    {0x00,0x00,0x00,0x00,0x00,0xC6,0xC6,0xC6,0xC6,0xC6,0xC6,0x7E,0x06,0x0C,0xF8,0x00},
    /* 122: z */
    {0x00,0x00,0x00,0x00,0x00,0xFE,0xCC,0x18,0x30,0x60,0xC6,0xFE,0x00,0x00,0x00,0x00},
    /* 123: { */
    {0x00,0x00,0x0E,0x18,0x18,0x18,0x70,0x18,0x18,0x18,0x18,0x0E,0x00,0x00,0x00,0x00},
    /* 124: | */
    {0x00,0x00,0x18,0x18,0x18,0x18,0x00,0x18,0x18,0x18,0x18,0x18,0x00,0x00,0x00,0x00},
    /* 125: } */
    {0x00,0x00,0x70,0x18,0x18,0x18,0x0E,0x18,0x18,0x18,0x18,0x70,0x00,0x00,0x00,0x00},
    /* 126: ~ */
    {0x00,0x00,0x76,0xDC,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00},
    /* 127: DEL (blank) */
    {0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00},
};

/* Initialize UI system */
int ui_init(void)
{
    LOG("Initializing UI...");

#ifdef NXDK
    /* Initialize pbKit */
    int status = pb_init();
    if (status != 0) {
        LOG_ERROR("pbKit init failed: %d", status);
        return -1;
    }

    /* Wait for GPU */
    pb_show_front_screen();

    /* Get framebuffer info */
    g_fb_width = SCREEN_WIDTH;
    g_fb_height = SCREEN_HEIGHT;
    g_fb_pitch = g_fb_width * 4;  /* 32-bit ARGB */

    LOG("UI initialized: %dx%d", g_fb_width, g_fb_height);
#endif

    return 0;
}

/* Shutdown UI system */
void ui_shutdown(void)
{
#ifdef NXDK
    pb_kill();
#endif
    LOG("UI shutdown");
}

/* Begin frame rendering */
void ui_begin_frame(void)
{
#ifdef NXDK
    pb_wait_for_vbl();
    pb_target_back_buffer();
    pb_reset();
    pb_erase_depth_stencil_buffer(0, 0, g_fb_width, g_fb_height);
    g_fb = (DWORD *)pb_back_buffer();
#endif
}

/* End frame rendering */
void ui_end_frame(void)
{
#ifdef NXDK
    while (pb_busy());
    while (pb_finished());
#endif
}

/* Clear screen with color */
void ui_clear(uint32_t color)
{
#ifdef NXDK
    if (!g_fb) return;

    for (int y = 0; y < g_fb_height; y++) {
        DWORD *row = g_fb + (y * g_fb_width);
        for (int x = 0; x < g_fb_width; x++) {
            row[x] = color;
        }
    }
#else
    for (int i = 0; i < SCREEN_WIDTH * SCREEN_HEIGHT; i++) {
        g_framebuffer[i] = color;
    }
#endif
}

/* Draw filled rectangle */
void ui_draw_rect(int x, int y, int width, int height, uint32_t color)
{
    if (x < 0) { width += x; x = 0; }
    if (y < 0) { height += y; y = 0; }
    if (x + width > SCREEN_WIDTH) width = SCREEN_WIDTH - x;
    if (y + height > SCREEN_HEIGHT) height = SCREEN_HEIGHT - y;
    if (width <= 0 || height <= 0) return;

#ifdef NXDK
    if (!g_fb) return;

    for (int py = y; py < y + height; py++) {
        DWORD *row = g_fb + (py * g_fb_width);
        for (int px = x; px < x + width; px++) {
            row[px] = color;
        }
    }
#else
    for (int py = y; py < y + height; py++) {
        for (int px = x; px < x + width; px++) {
            g_framebuffer[py * SCREEN_WIDTH + px] = color;
        }
    }
#endif
}

/* Draw single character */
static void draw_char(int x, int y, char c, uint32_t color)
{
    if (c < 32 || c > 127) c = '?';
    int char_index = c - 32;
    if (char_index < 0 || char_index >= 96) return;

#ifdef NXDK
    if (!g_fb) return;

    /* Draw character from font bitmap data */
    for (int py = 0; py < FONT_HEIGHT; py++) {
        if (y + py < 0 || y + py >= g_fb_height) continue;

        DWORD *row = g_fb + ((y + py) * g_fb_width);
        uint8_t font_row = g_font_data[char_index][py];

        for (int px = 0; px < FONT_WIDTH; px++) {
            if (x + px < 0 || x + px >= g_fb_width) continue;

            /* Check if pixel is set in font bitmap */
            if (font_row & (0x80 >> px)) {
                row[x + px] = color;
            }
        }
    }
#else
    /* Non-Xbox: skip rendering */
    (void)x; (void)y; (void)c; (void)color;
#endif
}

/* Draw text string */
void ui_draw_text(int x, int y, const char *text, uint32_t color)
{
    if (!text) return;

    int cx = x;
    while (*text) {
        if (*text == '\n') {
            cx = x;
            y += FONT_HEIGHT;
        } else {
            draw_char(cx, y, *text, color);
            cx += FONT_WIDTH;
        }
        text++;
    }
}

/* Draw centered text */
void ui_draw_text_centered(int y, const char *text, uint32_t color)
{
    if (!text) return;
    int len = strlen(text);
    int x = (SCREEN_WIDTH - len * FONT_WIDTH) / 2;
    ui_draw_text(x, y, text, color);
}

/* Draw header bar */
void ui_draw_header(const char *title)
{
    /* Background bar */
    ui_draw_rect(0, 0, SCREEN_WIDTH, 50, COLOR_BLACK);

    /* Title */
    ui_draw_text(20, 17, title, COLOR_RED);

    /* Divider line */
    ui_draw_rect(0, 48, SCREEN_WIDTH, 2, COLOR_RED);
}

/* Draw menu list */
void ui_draw_menu(const char **items, int count, int selected)
{
    int start_y = 80;
    int item_height = 35;

    for (int i = 0; i < count; i++) {
        int y = start_y + i * item_height;

        /* Selection highlight */
        if (i == selected) {
            ui_draw_rect(20, y - 5, SCREEN_WIDTH - 40, item_height - 5, COLOR_SELECTED);
        }

        /* Item text */
        uint32_t color = (i == selected) ? COLOR_WHITE : COLOR_TEXT;
        ui_draw_text(40, y, items[i], color);
    }
}

/* Draw file/media list */
void ui_draw_file_list(media_list_t *list)
{
    int start_y = 70;
    int item_height = 35;
    int visible_items = MIN(list->count - list->scroll_offset, MAX_ITEMS_PER_PAGE);

    /* Current path */
    ui_draw_text(20, 55, list->current_path, COLOR_TEXT_DIM);

    if (list->count == 0) {
        ui_draw_text_centered(start_y + 100, "No items found", COLOR_TEXT_DIM);
        return;
    }

    for (int i = 0; i < visible_items; i++) {
        int index = list->scroll_offset + i;
        if (index >= list->count) break;

        media_item_t *item = &list->items[index];
        int y = start_y + i * item_height;

        /* Selection highlight */
        if (index == list->selected_index) {
            ui_draw_rect(20, y - 2, SCREEN_WIDTH - 40, item_height - 5, COLOR_SELECTED);
        }

        /* Icon based on type */
        const char *icon = "";
        if (item->is_directory) {
            icon = "[D] ";
        } else if (item->type == MEDIA_TYPE_VIDEO) {
            icon = "[V] ";
        } else if (item->type == MEDIA_TYPE_AUDIO) {
            icon = "[A] ";
        }

        /* Item name */
        char display[MAX_TITLE_LENGTH + 8];
        snprintf(display, sizeof(display), "%s%s", icon, item->name);

        uint32_t color = (index == list->selected_index) ? COLOR_WHITE : COLOR_TEXT;
        ui_draw_text(40, y + 5, display, color);
    }

    /* Scroll indicators */
    if (list->scroll_offset > 0) {
        ui_draw_text_centered(start_y - 15, "^ More ^", COLOR_TEXT_DIM);
    }
    if (list->scroll_offset + MAX_ITEMS_PER_PAGE < list->count) {
        ui_draw_text_centered(start_y + MAX_ITEMS_PER_PAGE * item_height, "v More v", COLOR_TEXT_DIM);
    }

    /* Item count */
    char count_str[32];
    snprintf(count_str, sizeof(count_str), "%d / %d", list->selected_index + 1, list->count);
    ui_draw_text(SCREEN_WIDTH - 100, SCREEN_HEIGHT - 60, count_str, COLOR_TEXT_DIM);
}

/* Draw progress bar */
void ui_draw_progress_bar(int x, int y, int width, int height, float progress, uint32_t fg, uint32_t bg)
{
    /* Background */
    ui_draw_rect(x, y, width, height, bg);

    /* Foreground (progress) */
    int fill_width = (int)(width * CLAMP(progress, 0.0f, 1.0f));
    if (fill_width > 0) {
        ui_draw_rect(x, y, fill_width, height, fg);
    }
}

/* Draw loading screen */
void ui_draw_loading(const char *message)
{
    ui_draw_text_centered(SCREEN_HEIGHT / 2 - 20, "NEDFLIX", COLOR_RED);
    ui_draw_text_centered(SCREEN_HEIGHT / 2 + 20, message, COLOR_TEXT);

    /* Animated dots */
    static int dots = 0;
    static int frame = 0;
    if (++frame > 30) {
        dots = (dots + 1) % 4;
        frame = 0;
    }

    char loading[16] = "Loading";
    for (int i = 0; i < dots; i++) {
        strcat(loading, ".");
    }
    ui_draw_text_centered(SCREEN_HEIGHT / 2 + 50, loading, COLOR_TEXT_DIM);
}

/* Draw error screen */
void ui_draw_error(const char *message)
{
    ui_draw_text_centered(SCREEN_HEIGHT / 2 - 40, "ERROR", COLOR_RED);
    ui_draw_text_centered(SCREEN_HEIGHT / 2, message, COLOR_TEXT);
}

/* Draw playback HUD */
void ui_draw_playback_hud(playback_state_t *state)
{
    /* Semi-transparent bottom bar */
    ui_draw_rect(0, SCREEN_HEIGHT - 80, SCREEN_WIDTH, 80, 0xC0000000);

    /* Title */
    ui_draw_text(20, SCREEN_HEIGHT - 75, state->title, COLOR_WHITE);

    /* Progress bar */
    float progress = 0.0f;
    if (state->duration > 0) {
        progress = (float)(state->current_time / state->duration);
    }
    ui_draw_progress_bar(20, SCREEN_HEIGHT - 45, SCREEN_WIDTH - 40, 8, progress, COLOR_RED, COLOR_LIGHT_GRAY);

    /* Time display */
    char time_str[64];
    int cur_min = (int)state->current_time / 60;
    int cur_sec = (int)state->current_time % 60;
    int dur_min = (int)state->duration / 60;
    int dur_sec = (int)state->duration % 60;

    snprintf(time_str, sizeof(time_str), "%02d:%02d / %02d:%02d", cur_min, cur_sec, dur_min, dur_sec);
    ui_draw_text(20, SCREEN_HEIGHT - 30, time_str, COLOR_TEXT);

    /* Volume */
    char vol_str[16];
    snprintf(vol_str, sizeof(vol_str), "Vol: %d%%", state->volume);
    ui_draw_text(SCREEN_WIDTH - 100, SCREEN_HEIGHT - 30, vol_str, COLOR_TEXT);

    /* Pause indicator */
    if (state->is_paused) {
        ui_draw_text_centered(SCREEN_HEIGHT / 2, "|| PAUSED ||", COLOR_WHITE);
    }
}
